// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Call {
  id               String            @id @default(uuid())
  streamSid        String            @unique
  callSid          String?           @unique
  caller           String
  agent            String?
  startTime        DateTime          @default(now())
  endTime          DateTime?
  duration         Int?
  status           String            @default("active")
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  recordings       Recording[]
  transcripts      Transcript[]
  analytics        Analytics[]
  metadata         CallMetadata?
  teamId           String?
  team             Team?             @relation(fields: [teamId], references: [id], onDelete: SetNull)
}

model Recording {
  id               String            @id @default(uuid())
  callId           String
  call             Call              @relation(fields: [callId], references: [id], onDelete: Cascade)
  filePath         String
  fileUrl          String?
  format           String            @default("wav")
  codec            String            @default("pcm")
  sampleRate       Int               @default(8000)
  channels         Int               @default(1)
  duration         Float?
  sizeBytes        Int?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([callId])
}

model Transcript {
  id               String            @id @default(uuid())
  callId           String
  call             Call              @relation(fields: [callId], references: [id], onDelete: Cascade)
  speaker          String
  text             String
  confidence       Float?
  startTime        Float?
  endTime          Float?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([callId])
}

model Analytics {
  id               String            @id @default(uuid())
  callId           String
  call             Call              @relation(fields: [callId], references: [id], onDelete: Cascade)
  sentiment        String?
  sentimentScore   Float?
  talkTime         Float?
  silenceTime      Float?
  interruptions    Int?
  averageLatency   Float?
  metrics          String?
  snapshotTime     DateTime          @default(now())
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([callId])
}

model CallMetadata {
  id               String            @id @default(uuid())
  callId           String            @unique
  call             Call              @relation(fields: [callId], references: [id], onDelete: Cascade)
  language         String?
  region           String?
  deviceType       String?
  networkQuality   String?
  customData       String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model Campaign {
  id               String            @id @default(uuid())
  name             String
  description      String?
  status           String            @default("draft")
  script           String
  startDate        DateTime?
  endDate          DateTime?
  dailyLimit       Int               @default(100)
  retryAttempts    Int               @default(3)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  contacts         Contact[]
  callLogs         CallLog[]
  analytics        CampaignAnalytics?
  teamId           String?
  team             Team?             @relation(fields: [teamId], references: [id], onDelete: SetNull)
}

model Contact {
  id               String            @id @default(uuid())
  campaignId       String?
  campaign         Campaign?         @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  phone            String
  name             String?
  email            String?
  isValid          Boolean           @default(false)
  isDoNotCall      Boolean           @default(false)
  validationError  String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  callLogs         CallLog[]
}

model CallLog {
  id               String            @id @default(uuid())
  campaignId       String
  campaign         Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contactId        String
  contact          Contact           @relation(fields: [contactId], references: [id], onDelete: Cascade)
  duration         Int?
  result           String            @default("pending")
  recordingUrl     String?
  transcript       String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model FAQ {
  id               String            @id @default(uuid())
  question         String            @unique
  frequency        Int               @default(1)
  topic            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model UnansweredQuestion {
  id               String            @id @default(uuid())
  question         String            @unique
  frequency        Int               @default(1)
  lastAsked        DateTime          @default(now())
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model TopicAnalytics {
  id               String            @id @default(uuid())
  topic            String            @unique
  callCount        Int               @default(0)
  sentiment        Float?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model CampaignAnalytics {
  id               String            @id @default(uuid())
  campaignId       String            @unique
  campaign         Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  successRate      Float             @default(0)
  roi              Float             @default(0)
  cost             Float             @default(0)
  revenue          Float             @default(0)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model Team {
  id               String            @id @default(uuid())
  name             String
  description      String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  ownerId          String
  members          TeamMember[]
  calls            Call[]
  campaigns        Campaign[]
  apiKeys          ApiKey[]
  auditLogs        AuditLog[]
}

model TeamMember {
  id               String            @id @default(uuid())
  teamId           String
  team             Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId           String
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  role             String            @default("member")
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

model User {
  id               String            @id @default(uuid())
  email            String            @unique
  passwordHash     String
  firstName        String?
  lastName         String?
  isActive         Boolean           @default(true)
  lastLoginAt      DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  sessions         Session[]
  teamMemberships  TeamMember[]
  apiKeys          ApiKey[]
}

model Session {
  id               String            @id @default(uuid())
  userId           String
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken      String            @unique
  refreshToken     String            @unique
  accessTokenExpiresAt DateTime
  refreshTokenExpiresAt DateTime
  ipAddress        String?
  userAgent        String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([userId])
}

model ApiKey {
  id               String            @id @default(uuid())
  key              String            @unique
  name             String
  userId           String
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId           String?
  team             Team?             @relation(fields: [teamId], references: [id], onDelete: SetNull)
  lastUsedAt       DateTime?
  expiresAt        DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([key])
  @@index([userId])
  @@index([teamId])
}

model AuditLog {
  id               String            @id @default(uuid())
  teamId           String?
  team             Team?             @relation(fields: [teamId], references: [id], onDelete: SetNull)
  userId           String?
  action           String
  resourceType     String
  resourceId       String?
  details          String?
  ipAddress        String?
  userAgent        String?
  createdAt        DateTime          @default(now())

  @@index([teamId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}
